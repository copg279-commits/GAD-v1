<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificaci√≥n Licencia Venezuela + IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  
  <script>
    // Configurar worker de PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
  </script>

  <style>
    /* Estilos visuales */
    .delete-icon { cursor: pointer; transition: transform 0.2s; color: #ef4444; }
    .delete-icon:hover { transform: scale(1.1); }
    .listado-container { max-height: 300px; overflow-y: auto; }
    .cpi-table-container { max-height: 400px; overflow-y: auto; }
    
    /* Drop Zone y Animaciones */
    .drop-zone {
        transition: all 0.2s ease;
        border: 2px solid transparent;
        border-radius: 0.5rem;
        position: relative;
    }
    .drop-zone.drag-active {
        background-color: rgba(34, 197, 94, 0.15) !important; 
        border-color: #22c55e !important;
        border-style: dashed;
        transform: scale(1.02);
        z-index: 50;
    }
    .loading-overlay {
        position: fixed; inset: 0; background: rgba(255,255,255,0.9); 
        z-index: 50; display: flex; flex-direction: column; 
        align-items: center; justify-content: center;
    }
    .spinner {
        width: 50px; height: 50px; border: 5px solid #e5e7eb; 
        border-top: 5px solid #2563eb; border-radius: 50%; 
        animation: spin 1s linear infinite; margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    #aiResultBox { animation: slideDown 0.5s ease-out; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .alert-pulse { animation: alertPulse 2s infinite; }
    @keyframes alertPulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    
    /* Mensaje Auth */
    #auth-msg { text-align: center; color: #666; margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col pb-16 relative">

  <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="spinner"></div>
      <h3 class="text-blue-600 font-bold text-lg animate-pulse">Procesando Documento (IA)...</h3>
      <p id="loadingText" class="text-gray-500 text-sm mt-2">Analizando imagen/PDF...</p>
  </div>

  <div class="absolute top-2 right-2 z-40">
      <button onclick="toggleSettings()" class="bg-gray-800 text-white text-xs px-3 py-1 rounded shadow hover:bg-gray-700 flex items-center gap-1">
          ‚öôÔ∏è Configurar IA
      </button>
  </div>

  <div id="settingsPanel" class="hidden absolute top-10 right-2 w-72 bg-gray-800 border border-gray-600 shadow-xl rounded p-3 z-40 text-white">
      <div class="text-xs text-gray-400 mb-2">Proveedor: Google Gemini</div>
      <label class="block text-xs font-bold text-gray-300 mb-1">API Key:</label>
      <input type="password" id="apiKeyInput" class="w-full bg-gray-900 text-white text-xs border border-gray-700 p-1 rounded mb-2" placeholder="Pegar API Key aqu√≠...">
      <label class="block text-xs font-bold text-gray-300 mb-1">Modelo:</label>
      <input type="text" id="modelInput" class="w-full bg-gray-900 text-white text-xs border border-gray-700 p-1 rounded mb-3" placeholder="gemini-1.5-flash">
      <button onclick="saveSettings()" class="w-full bg-blue-600 text-white text-xs py-1.5 rounded hover:bg-blue-700 font-bold">GUARDAR CONFIGURACI√ìN</button>
  </div>

  <header class="bg-blue-600 w-full flex justify-center items-center py-2">
    <div class="w-40 h-40 rounded-full overflow-hidden shadow-lg">
      <img src="logogad.png" alt="Logo GAD" class="w-full h-full object-cover block">
    </div>
  </header>

  <h1 class="text-black text-center mt-6 text-xl font-bold px-4">
    Verificaci√≥n Licencia Venezuela
  </h1>
  <h2 class="text-gray-700 text-center mt-2 px-4 text-sm">
    Arrastra el PDF/Imagen de la licencia o escribe el N¬∫
  </h2>
  
  <div id="mainDropZone" class="drop-zone w-11/12 max-w-md mx-auto mt-4 p-2 bg-white rounded shadow-sm">
    <div class="w-full pointer-events-none select-none">
      <img src="logovenezuela.png" alt="Logo Venezuela" class="w-full">
    </div>

    <input 
      type="number" 
      id="numero" 
      placeholder="Ingresa el Nro De Verificaci√≥n manualmente" 
      class="block mx-auto mt-4 p-3 text-base w-full border border-gray-300 rounded-md text-center focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm"
    />
  </div>

  <button 
    onclick="buscarFecha()" 
    class="block mx-auto mt-4 w-11/12 max-w-md bg-blue-600 text-white font-bold py-3 rounded-md hover:bg-blue-700 transition shadow-lg"
  >
    Consultar Manualmente
  </button>

  <div id="output" class="mt-6 text-gray-700 text-center w-11/12 max-w-md mx-auto"></div>

  <div id="aiResultBox" class="hidden mt-4 w-11/12 max-w-md mx-auto bg-white border-2 rounded-lg p-0 text-center shadow-xl overflow-hidden">
      <div id="aiHeader" class="bg-gray-100 p-3 border-b">
          <h3 class="font-bold text-lg" id="aiTitle">üîç An√°lisis Completado</h3>
      </div>
      <div class="p-4">
          <div class="grid grid-cols-2 gap-2 text-sm text-gray-800 text-left mb-4">
              <div class="bg-gray-50 p-2 rounded border">
                  <span class="text-xs text-gray-500 block uppercase">Nro De Verificaci√≥n</span>
                  <span id="aiNumero" class="font-mono font-bold text-black text-lg break-all"></span>
              </div>
              <div class="bg-gray-50 p-2 rounded border">
                  <span class="text-xs text-gray-500 block uppercase">F. Expedici√≥n</span>
                  <span id="aiFecha" class="font-mono font-bold text-black text-lg"></span>
              </div>
          </div>

          <div id="aiValidationMsg" class="mb-4 text-sm p-2 rounded border"></div>
          
          <div id="aiActions"></div>
          
          <button onclick="document.getElementById('aiResultBox').classList.add('hidden')" class="w-full mt-3 text-gray-400 text-xs underline">
              Cerrar panel
          </button>
      </div>
  </div>
  
  <div id="auth-msg">Conectando con base de datos V4...</div>

  <div id="main-panel" class="bg-white shadow-md rounded-lg p-6 mt-4 text-center w-11/12 max-w-md mx-auto" style="display:none;">
    <h3 class="text-lg font-semibold mb-4">Gesti√≥n de Datos</h3>
    <button id="mostrarFormularioBtn" class="w-full bg-green-600 text-white py-2 rounded-md shadow hover:bg-green-700 text-sm">
      Introduzca nuevo Nro de Verificaci√≥n
    </button>
    <button id="mostrarListadoBtn" class="w-full bg-blue-500 text-white py-2 rounded-md shadow hover:bg-blue-600 mt-2 text-sm">
      Consultar Lista Completa
    </button>
    
    <div id="formularioNuevosDatos" class="mt-4 hidden text-left">
      <div class="mb-4">
        <label for="nuevoNumero" class="block text-sm font-bold text-gray-700 mb-1">Nro De Verificaci√≥n:</label>
        <input type="number" id="nuevoNumero" placeholder="Ej: 210205080686" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="mb-4">
        <label for="nuevaFecha" class="block text-sm font-bold text-gray-700 mb-1">Fecha de Expedici√≥n:</label>
        <input type="date" id="nuevaFecha" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="flex space-x-2">
        <button onclick="guardarNuevoNumero()" class="w-1/2 bg-blue-600 text-white py-2 rounded-md shadow hover:bg-blue-700">Guardar</button>
        <button onclick="limpiarCampos()" class="w-1/2 bg-gray-400 text-white py-2 rounded-md shadow hover:bg-gray-500">Limpiar</button>
      </div>
      <div id="mensajeGuardado" class="mt-4 text-sm font-medium text-center"></div>
    </div>

    <div id="cpiDataTable" class="mt-4 hidden">
        <h3 class="text-lg font-semibold mb-4 text-center">Listado Completo</h3>
        <div class="cpi-table-container">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                    <tr>
                        <th scope="col" class="px-6 py-3">Nro Verificaci√≥n</th>
                        <th scope="col" class="px-6 py-3">Fecha</th>
                        <th scope="col" class="px-6 py-3"></th>
                    </tr>
                </thead>
                <tbody id="cpiList"></tbody>
            </table>
        </div>
    </div>
  </div>

  <div class="mt-8 flex justify-center">
    <button onclick="window.location.href='index.html'"
            class="w-11/12 max-w-md p-4 bg-yellow-400 text-black font-bold rounded-lg shadow-md transition hover:bg-yellow-200">
        MEN√ö PRINCIPAL
    </button>
  </div>

 <footer class="mt-auto text-center py-6 bg-gray-200">
    <hr class="border-t border-gray-400 w-11/12 max-w-md mx-auto mb-4">
    <p class="font-bold">GRUPO DE AN√ÅLISIS DOCUMENTAL</p>
    <p class="font-bold">POLIC√çA LOCAL DE ALICANTE</p>
    <p>&copy; GAD - Todos los derechos reservados</p>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // --- 1. CONFIGURACI√ìN V4 ---
    const firebaseConfig = {
      apiKey: "AIzaSyCY8V_P7m8lZUvGbMVlGaa-GVhbmyikmag",
      authDomain: "gad-alicante-v4.firebaseapp.com",
      databaseURL: "https://gad-alicante-v4-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gad-alicante-v4",
      storageBucket: "gad-alicante-v4.firebasestorage.app",
      messagingSenderId: "119727545224",
      appId: "1:119727545224:web:36880c50d196c456cdb83d"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    const licenciasNuevasRef = database.ref('licencias_venezuela_nuevas');

    let datosCompletos = [];
    let isUserAuthenticated = false;
    
    // --- 2. SEGURIDAD ESTRICTA (WAIT FOR AUTH) ---
    auth.onAuthStateChanged((user) => {
        if (user) {
            isUserAuthenticated = true;
            console.log("Usuario V4 Autenticado:", user.email);
            
            document.getElementById('auth-msg').style.display = 'none';
            document.getElementById('main-panel').style.display = 'block';
            
            cargarDatosDesdeFirebase();
        } else {
            console.warn("No hay sesi√≥n.");
            document.getElementById('auth-msg').innerHTML = "<span class='text-red-500 font-bold'>‚ö†Ô∏è Acceso Denegado. Inicia sesi√≥n en el Men√∫.</span>";
        }
    });

    function cargarDatosDesdeFirebase() {
      licenciasNuevasRef.on('value', snapshot => {
        datosCompletos = [];
        snapshot.forEach(childSnapshot => {
          const nuevoDato = childSnapshot.val();
          const key = childSnapshot.key;
          if (nuevoDato.numero && nuevoDato.fecha) {
              datosCompletos.push({
                numero: parseInt(nuevoDato.numero),
                fecha: nuevoDato.fecha,
                key: key
              });
          }
        });
        datosCompletos.sort((a, b) => a.numero - b.numero);
        renderizarTablaCpi();
      }, (error) => {
          console.error("Error Firebase:", error);
          document.getElementById('auth-msg').style.display = 'block';
          document.getElementById('auth-msg').innerHTML = "<span class='text-red-500'>Error de Permisos V4: " + error.code + "</span>";
      });
    }
    
    // --- RESTO DE FUNCIONALIDADES (Igual que antes) ---
    const mostrarFormularioBtn = document.getElementById('mostrarFormularioBtn');
    const formularioNuevosDatos = document.getElementById('formularioNuevosDatos');
    const nuevoNumeroInput = document.getElementById('nuevoNumero');
    const nuevaFechaInput = document.getElementById('nuevaFecha');
    const mensajeGuardadoDiv = document.getElementById('mensajeGuardado');
    const mostrarListadoBtn = document.getElementById('mostrarListadoBtn');
    const cpiDataTable = document.getElementById('cpiDataTable');
    const cpiListDiv = document.getElementById('cpiList');

    mostrarFormularioBtn.addEventListener('click', () => {
        formularioNuevosDatos.classList.toggle('hidden');
        cpiDataTable.classList.add('hidden');
        limpiarCampos();
    });

    mostrarListadoBtn.addEventListener('click', () => {
        cpiDataTable.classList.toggle('hidden');
        formularioNuevosDatos.classList.add('hidden');
        limpiarCampos();
    });

    function limpiarCampos() {
        nuevoNumeroInput.value = '';
        nuevaFechaInput.value = '';
        mensajeGuardadoDiv.textContent = '';
        mensajeGuardadoDiv.style.color = '';
    }

    function guardarNuevoNumero() {
        if (!isUserAuthenticated) return alert("No tienes permisos en V4.");
        
        const nuevoNumero = parseInt(nuevoNumeroInput.value);
        const nuevaFecha = nuevaFechaInput.value;

        if (isNaN(nuevoNumero) || !nuevaFecha) {
            mensajeGuardadoDiv.textContent = 'Datos inv√°lidos.';
            mensajeGuardadoDiv.style.color = 'orange';
            return;
        }

        const chequeo = verificarCongruencia(nuevoNumero, nuevaFecha.split('-').reverse().join('/'));
        
        if (chequeo.existe) {
             mensajeGuardadoDiv.innerHTML = `YA EXISTE ESTE N√öMERO.`;
             mensajeGuardadoDiv.style.color = 'red';
             return;
        }

        if (chequeo.esFraude) {
            mensajeGuardadoDiv.innerHTML = `<p class='text-red-500 font-bold'>${chequeo.mensaje}</p>`;
            return;
        }

        const [year, month, day] = nuevaFecha.split('-');
        const fechaFormateada = `${day}/${month}/${year}`;

        licenciasNuevasRef.child(String(nuevoNumero)).set({ numero: nuevoNumero, fecha: fechaFormateada })
            .then(() => {
                mensajeGuardadoDiv.textContent = 'Guardado con √©xito.';
                mensajeGuardadoDiv.style.color = 'green';
                setTimeout(() => {
                    limpiarCampos();
                    formularioNuevosDatos.classList.add('hidden');
                }, 2000);
            })
            .catch(error => {
                mensajeGuardadoDiv.textContent = 'Error: ' + error.message;
                mensajeGuardadoDiv.style.color = 'red';
            });
    }

    function renderizarTablaCpi() {
      cpiListDiv.innerHTML = '';
      const datosOrdenados = [...datosCompletos].sort((a, b) => a.numero - b.numero);
      
      datosOrdenados.forEach(dato => {
        const fila = document.createElement('tr');
        fila.classList.add('bg-white', 'border-b', 'hover:bg-gray-50');

        const celdaNumero = document.createElement('td');
        celdaNumero.classList.add('px-6', 'py-4', 'font-medium', 'text-gray-900', 'whitespace-nowrap');
        celdaNumero.textContent = dato.numero;

        const celdaFecha = document.createElement('td');
        celdaFecha.classList.add('px-6', 'py-4');
        celdaFecha.textContent = dato.fecha;

        const celdaAccion = document.createElement('td');
        celdaAccion.classList.add('px-6', 'py-4', 'text-right');
        const deleteIcon = document.createElement('span');
        deleteIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500 delete-icon inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>`;
        deleteIcon.onclick = () => confirmarEliminarCpi(dato.key, dato.numero);
        celdaAccion.appendChild(deleteIcon);

        fila.appendChild(celdaNumero);
        fila.appendChild(celdaFecha);
        fila.appendChild(celdaAccion);
        cpiListDiv.appendChild(fila);
      });
    }

    function confirmarEliminarCpi(key, numero) {
      if(!isUserAuthenticated) return alert("No autorizado.");
      if (confirm(`¬øEliminar registro ${numero}?`)) {
        licenciasNuevasRef.child(key).remove();
      }
    }

    // --- CONFIGURACI√ìN IA (RESTO DE C√ìDIGO) ---
    let geminiApiKey = localStorage.getItem('ai_api_key') || '';
    let geminiModelName = localStorage.getItem('gemini_model_name') || 'gemini-1.5-flash';

    function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); document.getElementById('apiKeyInput').value = geminiApiKey; document.getElementById('modelInput').value = geminiModelName; }
    function saveSettings() {
        const key = document.getElementById('apiKeyInput').value.trim();
        const model = document.getElementById('modelInput').value.trim();
        if(key && model) {
            geminiApiKey = key; geminiModelName = model;
            localStorage.setItem('ai_api_key', key); localStorage.setItem('gemini_model_name', model);
            alert("Configuraci√≥n guardada."); toggleSettings();
        } else { alert("Rellena todos los campos."); }
    }

    async function callGemini(base64Image) {
        if (!geminiApiKey) { alert("‚ö†Ô∏è Falta la API Key de Google Gemini."); return null; }
        const PROMPT = `Analiza la imagen de este documento de licencia de conducir de Venezuela. C√©ntrate exclusivamente en la PARTE FRONTAL... Identifica y extrae: 1. "numero": El "Nro De Verificaci√≥n"... 2. "fecha": La "F.Expedici√≥n"... Devuelve JSON: {"numero": "...", "fecha": "DD/MM/AAAA"}`;
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModelName}:generateContent?key=${geminiApiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [ { text: PROMPT }, { inline_data: { mime_type: "image/jpeg", data: base64Image } } ] }] })
            });
            const data = await response.json(); if (data.error) throw new Error(data.error.message);
            return JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
        } catch (error) { alert(`Error al analizar con IA: ` + error.message); return null; }
    }

    async function processFile(file) {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.remove('hidden');
        try {
            let base64Image = "";
            if (file.type === "application/pdf") { base64Image = await convertPdfToImage(file); } 
            else if (file.type.startsWith("image/")) { base64Image = await new Promise((resolve) => { const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result.split(',')[1]); reader.readAsDataURL(file); }); } 
            else { throw new Error("Formato no soportado."); }

            const result = await callGemini(base64Image);
            overlay.classList.add('hidden');

            if (result) {
                const numLimpio = result.numero.replace(/\D/g, ''); 
                const fechaLimpia = formatoFechaIA(result.fecha);
                if (!numLimpio) { alert("La IA no pudo encontrar el 'Nro De Verificaci√≥n'."); return; }
                document.getElementById('numero').value = numLimpio;
                buscarFecha(); 
                mostrarResultadoIA(numLimpio, fechaLimpia);
            }
        } catch (error) { overlay.classList.add('hidden'); alert(error.message); }
    }

    async function convertPdfToImage(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const page = await pdf.getPage(1); 
        const viewport = page.getViewport({ scale: 2.5 }); 
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        await page.render({ canvasContext: context, viewport: viewport }).promise;
        return canvas.toDataURL('image/jpeg', 0.9).split(',')[1];
    }

    function formatoFechaIA(fechaStr) {
        if (!fechaStr) return "";
        return fechaStr.replace(/\./g, '/').replace(/-/g, '/');
    }

    function mostrarResultadoIA(numero, fecha) {
        const aiBox = document.getElementById('aiResultBox');
        document.getElementById('aiNumero').textContent = numero;
        document.getElementById('aiFecha').textContent = fecha;
        aiBox.classList.remove('hidden');

        const chequeo = verificarCongruencia(parseInt(numero), fecha);
        const aiMsg = document.getElementById('aiValidationMsg');
        const aiActions = document.getElementById('aiActions');

        if (chequeo.esFraude) {
            aiBox.className = "mt-4 w-11/12 max-w-md mx-auto bg-white border-2 rounded-lg shadow-xl overflow-hidden border-red-500 alert-pulse";
            document.getElementById('aiTitle').textContent = "‚ö†Ô∏è POSIBLE DOCUMENTO FALSO";
            aiMsg.className = "bg-red-50 text-red-800 p-3 rounded font-bold border border-red-200 text-left";
            aiMsg.innerHTML = chequeo.mensaje;
            aiActions.innerHTML = ""; 
        } else if (chequeo.existe) {
            aiBox.className = "mt-4 w-11/12 max-w-md mx-auto bg-white border-2 rounded-lg shadow-xl overflow-hidden border-blue-500";
            document.getElementById('aiTitle').textContent = "‚ÑπÔ∏è Documento ya registrado";
            aiMsg.className = "bg-blue-50 text-blue-800 p-3 rounded border border-blue-200 text-left";
            aiMsg.innerHTML = "Este 'Nro De Verificaci√≥n' ya existe exactamente en la base de datos.";
            aiActions.innerHTML = "";
        } else {
            aiBox.className = "mt-4 w-11/12 max-w-md mx-auto bg-white border-2 rounded-lg shadow-xl overflow-hidden border-green-500";
            document.getElementById('aiTitle').textContent = "‚úÖ Documento Coherente";
            aiMsg.className = "bg-green-50 text-green-800 p-3 rounded border border-green-200 text-left";
            aiMsg.innerHTML = "La numeraci√≥n y fecha siguen la progresi√≥n aritm√©tica l√≥gica de Venezuela.";
            window.tempAiData = { numero: parseInt(numero), fecha: fecha };
            aiActions.innerHTML = `<button onclick="guardarDesdeAI()" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700 transition flex justify-center items-center gap-2 shadow-lg transform active:scale-95">A√ëADIR A BASE DE DATOS</button>`;
        }
    }

    function verificarCongruencia(nuevoNumero, nuevaFechaStr) {
        if (!nuevaFechaStr || nuevaFechaStr.length < 8) return { esFraude: false, existe: false, mensaje: "Fecha no v√°lida detectada." };
        const [d, m, y] = nuevaFechaStr.split('/').map(Number);
        const fechaNueva = new Date(y, m - 1, d);
        const exacto = datosCompletos.find(d => d.numero === nuevoNumero);
        if (exacto) return { esFraude: false, existe: true, mensaje: "" };

        const antes = datosCompletos.filter(d => d.numero <= nuevoNumero).sort((a, b) => b.numero - a.numero)[0];
        const despues = datosCompletos.find(d => d.numero > nuevoNumero);
        
        let mensajeError = "";
        let esFraude = false;

        if (antes) {
            const [da, ma, ya] = antes.fecha.split('/').map(Number);
            if (fechaNueva < new Date(ya, ma-1, da)) {
                esFraude = true;
                mensajeError += `‚õî <strong>INCONGRUENCIA:</strong><br>El N¬∫ ${nuevoNumero} es posterior al N¬∫ ${antes.numero}, pero su fecha (${nuevaFechaStr}) es ANTERIOR a la registrada (${antes.fecha}).<br><br>`;
            }
        }
        if (despues) {
            const [dd, md, yd] = despues.fecha.split('/').map(Number);
            if (fechaNueva > new Date(yd, md-1, dd)) {
                esFraude = true;
                mensajeError += `‚õî <strong>INCONGRUENCIA:</strong><br>El N¬∫ ${nuevoNumero} es anterior al N¬∫ ${despues.numero}, pero su fecha (${nuevaFechaStr}) es POSTERIOR a la registrada (${despues.fecha}).`;
            }
        }
        return { esFraude: esFraude, existe: false, mensaje: esFraude ? mensajeError : "" };
    }

    function guardarDesdeAI() {
        if (!window.tempAiData || !isUserAuthenticated) return alert("No autorizado.");
        const { numero, fecha } = window.tempAiData;
        licenciasNuevasRef.child(String(numero)).set({ numero: numero, fecha: fecha }).then(() => {
                alert(`‚úÖ Guardado.`);
                document.getElementById('aiResultBox').classList.add('hidden');
                window.tempAiData = null;
            }).catch(error => alert('Error: ' + error.message));
    }

    function buscarFecha() {
      const numero = parseInt(document.getElementById("numero").value);
      const output = document.getElementById("output");
      if (isNaN(numero)) { output.innerHTML = "<p class='text-red-500 font-semibold'>Ingresa un Nro De Verificaci√≥n v√°lido.</p>"; return; }
      
      if(datosCompletos.length === 0 && !isUserAuthenticated) {
          output.innerHTML = "<p class='text-orange-500'>Conectando... (Verifica sesi√≥n)</p>";
          return;
      }
      
      const exacto = datosCompletos.find(d => d.numero === numero);
      if (exacto) { output.innerHTML = `<div class="bg-green-50 p-4 rounded border border-green-200"><p class='text-green-800 font-bold'>‚úÖ REGISTRO EXACTO ENCONTRADO</p><p>Nro: ${exacto.numero}</p><p class='font-bold'>Fecha: ${exacto.fecha}</p></div>`; return; }
      
      const datosOrd = [...datosCompletos].sort((a,b) => a.numero - b.numero);
      const antes = datosOrd.filter(d => d.numero <= numero).pop();
      const despues = datosOrd.find(d => d.numero > numero);

      if (!antes) { output.innerHTML = "<p class='text-red-500 font-bold'>N√öMERO SIN REFERENCIA PREVIA</p>"; return; }
      if (!despues) { output.innerHTML = `<div class="bg-orange-50 p-4 rounded border border-orange-200"><p class='text-orange-800 font-bold'>‚ö†Ô∏è N√öMERO POSTERIOR AL √öLTIMO</p><p>√öltimo: ${antes.numero} (${antes.fecha})</p></div>`; return; }

      const prop = (numero - antes.numero) / (despues.numero - antes.numero);
      const [d1, m1, y1] = antes.fecha.split("/").map(Number);
      const [d2, m2, y2] = despues.fecha.split("/").map(Number);
      const f1 = new Date(y1, m1-1, d1).getTime();
      const f2 = new Date(y2, m2-1, d2).getTime();
      
      if (f1 > f2) { output.innerHTML = "<p class='text-red-500 font-bold'>¬°ERROR CR√çTICO EN BD! FECHAS INCOHERENTES</p>"; return; }

      const fEst = new Date(f1 + prop * (f2 - f1));
      output.innerHTML = `<div class="bg-blue-50 p-4 rounded border border-blue-200"><p class='text-blue-800 font-bold mb-2'>ESTIMACI√ìN ARITM√âTICA</p><p class="text-sm text-gray-600">Rango: <strong>${antes.fecha}</strong> y <strong>${despues.fecha}</strong></p><p class='text-green-600 font-bold text-xl mt-2'>Fecha Estimada: ${fEst.toLocaleDateString("es-ES")}</p></div>`;
    }

    const dz = document.getElementById('mainDropZone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => { dz.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false); });
    ['dragenter', 'dragover'].forEach(e => dz.addEventListener(e, () => dz.classList.add('drag-active'), false));
    ['dragleave', 'drop'].forEach(e => dz.addEventListener(e, () => dz.classList.remove('drag-active'), false));
    dz.addEventListener('drop', e => { if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); }, false);
    window.addEventListener('paste', e => { for(let i of e.clipboardData.items) if(i.type.startsWith("image")) processFile(i.getAsFile()); });
    document.getElementById("numero").addEventListener("keypress", e => { if (e.key === "Enter") buscarFecha(); });
  </script>
</body>
</html>